<div class="form-page-container">
  <header class="form-header">
    <h1 class="page-title">Ajouter un challenge</h1>
    <a routerLink="/admin/challengelist" class="back-btn">
      <img src="images/832_8591.svg" alt="Back icon">
      <span>Retour</span>
    </a>
  </header>
  <div class="form-subtitle">Remplissez les informations suivantes pour ajouter un challenge dans votre plateforme!</div>

  <div class="form-body">
    <form class="challenge-form-body" [formGroup]="form" (ngSubmit)="onSubmit()">
      <fieldset class="form-section">
        <legend class="section-title">
          <img src="images/816_4202.svg" alt="Info icon">
          <h2>Information de bases</h2>
        </legend>
        <hr class="divider">

        <div class="form-group full-width">
          <label for="type-challenge">Type Challenge <span class="required">*</span></label>
          <div class="select-wrapper">
            <select id="type-challenge" formControlName="typeChallenge">
              <option *ngFor="let opt of typeOptions" [ngValue]="opt.value">{{ opt.label }}</option>
            </select>
            <img src="images/829_6592.svg" alt="Dropdown arrow" class="select-arrow">
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="niveau">Niveau <span class="required">*</span></label>
            <div class="select-wrapper">
              <select id="niveau" formControlName="niveauId">
                <option [ngValue]="null">S√©lectionner un niveau</option>
                <option *ngFor="let n of niveaux" [ngValue]="n.id">{{ $any(n).nom || ('Niveau ' + n.id) }}</option>
              </select>
              <img src="images/816_4265.svg" alt="Dropdown arrow" class="select-arrow">
            </div>
          </div>
          <div class="form-group">
            <label for="titre-challenge">Titre du challenge <span class="required">*</span></label>
            <input type="text" id="titre-challenge" placeholder="Donnez un titre" formControlName="titre">
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="classe">Classe</label>
            <div class="select-wrapper">
              <select id="classe" formControlName="classeId">
                <option [ngValue]="null">S√©lectionner une classe</option>
                <option *ngFor="let c of classes" [ngValue]="c.id">{{ $any(c).nom || ('Classe ' + c.id) }}</option>
              </select>
              <img src="images/816_4265.svg" alt="Dropdown arrow" class="select-arrow">
            </div>
          </div>
        </div>

        <div class="form-group full-width">
          <label for="description">Description</label>
          <textarea id="description" placeholder="Description detaill√©e du d√©fis..." rows="2" formControlName="description"></textarea>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="date-debut">Date d√©but <span class="required">*</span></label>
            <div class="input-with-icon">
              <input type="datetime-local" id="date-debut" formControlName="dateDebut">
              <img src="images/816_4260.svg" alt="Calendar icon" class="input-icon">
            </div>
          </div>
          <div class="form-group">
            <label for="date-fin">Date fin <span class="required">*</span></label>
            <div class="input-with-icon">
              <input type="datetime-local" id="date-fin" formControlName="dateFin">
              <img src="images/816_4309.svg" alt="Calendar icon" class="input-icon">
            </div>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="recompenses">Systeme de recompenses <span class="required">*</span></label>
            <div class="select-wrapper">
              <select id="recompenses" formControlName="rewardMode">
                <option *ngFor="let m of rewardModes" [ngValue]="m.value">{{ m.label }}</option>
              </select>
              <img src="images/816_4332.svg" alt="Dropdown arrow" class="select-arrow">
            </div>
          </div>
          <div class="form-group">
            <label for="personnes">Combien de personnes <span class="required">*</span></label>
            <div class="select-wrapper">
              <select id="personnes" formControlName="winnersCount">
                <option [ngValue]="1">Le premier</option>
                <option [ngValue]="3">Les trois premiers</option>
              </select>
              <img src="images/816_4377.svg" alt="Dropdown arrow" class="select-arrow">
            </div>
          </div>
        </div>
      </fieldset>

      <fieldset class="form-section">
        <legend class="section-title with-button">
          <div class="title-content">
            <img src="images/816_4206.svg" alt="Questions icon">
            <h2>Questions du challenge</h2>
          </div>
          <button type="button" class="btn-inline-add" (click)="ajouterQuestion()">
            <img src="images/816_4280.svg" alt="Add icon">
            <span>Ajouter une question</span>
          </button>
        </legend>
        <hr class="divider">

        <div formArrayName="questions">
          <div class="question-block" *ngFor="let q of questions.controls; let i = index" [formGroupName]="i">
            <div class="question-header">
              <h3>Question {{ i + 1 }}</h3>
              <div class="question-actions">
                <button type="button" class="btn-action" (click)="dupliquerQuestion(i)">‚ßâ</button>
                <button type="button" class="btn-action" (click)="deplacerQuestion(i, 'up')" [disabled]="i === 0">‚Üë</button>
                <button type="button" class="btn-action" (click)="deplacerQuestion(i, 'down')" [disabled]="i === questions.length - 1">‚Üì</button>
                <button type="button" class="btn-action btn-danger" (click)="supprimerQuestion(i)" [disabled]="questions.length === 1">üóëÔ∏è</button>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label [for]="'type-questions-' + i">Type de questions <span class="required">*</span></label>
                <div class="select-wrapper">
                  <select [id]="'type-questions-' + i" formControlName="typeQuestion" (change)="onTypeQuestionChange(i)">
                    <option *ngFor="let t of typesQuestions" [value]="t.value">{{ t.label }}</option>
                  </select>
                  <img src="images/816_4223.svg" alt="Dropdown arrow" class="select-arrow rotated">
                </div>
                <div class="type-description">
                  {{ getDescriptionType(questions.at(i).get('typeQuestion')?.value) }}
                </div>
              </div>
              <div class="form-group">
                <label [for]="'points-' + i">Points</label>
                <input type="number" [id]="'points-' + i" formControlName="points" min="1">
              </div>
            </div>

            <div class="form-group full-width">
              <label [for]="'question-' + i">Question {{ i + 1 }} <span class="required">*</span></label>
              <input type="text" [id]="'question-' + i" placeholder="Saisissez la question..." formControlName="question">
            </div>

            <!-- R√©ponses QCM/QCU / multi / ordre -->
            <div class="form-group full-width" *ngIf="questions.at(i).get('typeQuestion')?.value !== 'appariement'
                                                    && questions.at(i).get('typeQuestion')?.value !== 'reponse_courte'
                                                    && questions.at(i).get('typeQuestion')?.value !== 'reponse_longue'
                                                    && questions.at(i).get('typeQuestion')?.value !== 'vrai_faux'">
              <div class="answers-list" formArrayName="reponses">
                <div class="answer-row" *ngFor="let rep of getReponses(i).controls; let j = index" [formGroupName]="j">
                  <div class="answer-label">{{ rep.get('lettre')?.value }}</div>
                  <input type="text" formControlName="texte" [placeholder]="'R√©ponse ' + rep.get('lettre')?.value">
                  <button type="button" class="btn-checkbox" [class.correct]="rep.get('correcte')?.value"
                          (click)="onReponseCorrecteChange(i, j, questions.at(i).get('typeQuestion')?.value)">üîò</button>
                  <button type="button" class="btn-action btn-danger" (click)="supprimerReponse(i, j)" [disabled]="getReponses(i).length <= 2">üóëÔ∏è</button>
                </div>
                <div class="answers-actions">
                  <button type="button" class="btn-inline-add" (click)="ajouterReponse(i)" [disabled]="getReponses(i).length >= 6">Ajouter une r√©ponse</button>
                </div>
              </div>
            </div>

            <!-- Vrai / Faux -->
            <div class="form-group full-width" *ngIf="questions.at(i).get('typeQuestion')?.value === 'vrai_faux'">
              <div class="answers-list" formArrayName="reponses">
                <div class="answer-row" *ngFor="let rep of getReponses(i).controls; let j = index" [formGroupName]="j">
                  <div class="answer-label">{{ rep.get('lettre')?.value }}</div>
                  <input type="text" formControlName="texte" readonly>
                  <button type="button" class="btn-checkbox" [class.correct]="rep.get('correcte')?.value"
                          (click)="onReponseCorrecteChange(i, j, 'vrai_faux')">üîò</button>
                </div>
              </div>
            </div>

            <!-- R√©ponse courte -->
            <div class="form-group full-width" *ngIf="questions.at(i).get('typeQuestion')?.value === 'reponse_courte'">
              <label>R√©ponse attendue <span class="required">*</span></label>
              <input type="text" formControlName="bonneReponse" placeholder="Saisissez la r√©ponse correcte...">
            </div>

            <!-- R√©ponse longue -->
            <div class="form-group full-width" *ngIf="questions.at(i).get('typeQuestion')?.value === 'reponse_longue'">
              <label>R√©ponse attendue <span class="required">*</span></label>
              <textarea formControlName="bonneReponse" rows="3" placeholder="Saisissez la r√©ponse correcte..."></textarea>
            </div>

            <!-- Appariement -->
            <div class="form-group full-width" *ngIf="questions.at(i).get('typeQuestion')?.value === 'appariement'">
              <div class="appariement-grid" formArrayName="pairesAppariement">
                <div class="appariement-row" *ngFor="let p of getPaires(i).controls; let j = index" [formGroupName]="j">
                  <input type="text" formControlName="elementGauche" placeholder="√âl√©ment de gauche">
                  <input type="text" formControlName="elementDroit" placeholder="√âl√©ment de droite">
                  <button type="button" class="btn-action btn-danger" (click)="supprimerPaireAppariement(i, j)" [disabled]="getPaires(i).length <= 2">üóëÔ∏è</button>
                </div>
              </div>
              <button type="button" class="btn-inline-add" (click)="ajouterPaireAppariement(i)">Ajouter une paire</button>
            </div>

            <!-- Indicateur de bonne r√©ponse (sauf r√©ponses courtes/longues et appariement) -->
            <div class="bonne-reponse-indicator"
                 *ngIf="questions.at(i).get('typeQuestion')?.value !== 'reponse_courte'
                      && questions.at(i).get('typeQuestion')?.value !== 'reponse_longue'
                      && questions.at(i).get('typeQuestion')?.value !== 'appariement'">
              <span class="indicator-label">Bonne(s) r√©ponse(s) s√©lectionn√©e(s) :</span>
              <span class="indicator-value">
                {{ questions.at(i).get('bonneReponse')?.value || 'Aucune' }}
              </span>
            </div>

            <hr class="divider" *ngIf="i < questions.length - 1">
          </div>
        </div>
      </fieldset>

      <div class="form-actions">
        <!--merged image-->
        <button type="button" class="btn btn-cancel" (click)="onAnnuler()">
          <img src="images/816_4275.svg" alt="Cancel icon">
          <span>Annuler</span>
        </button>
        <!--merged image-->
        <button type="button" class="btn btn-add-question" (click)="ajouterQuestion()">
          <img src="images/816_4229.svg" alt="Add icon">
          <span>Ajouter une question</span>
        </button>
        <!--merged image-->
        <button type="submit" class="btn btn-submit">
          <img src="images/816_4271.svg" alt="Save icon">
          <span>Enregistrer le challenge</span>
        </button>
      </div>
    </form>
  </div>
</div>
